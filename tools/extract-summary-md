#!/usr/bin/env python3
"""Extract summary block from a markdown file.

Looks for a YAML-style summary block at the top of the file:

    ---
    summary: One-line summary of the section
    keywords: comma, separated, keywords
    ---

Usage: extract-summary-md <file-path>
       extract-summary-md --batch <file1> <file2> ...
       find ... | extract-summary-md --stdin

Output: file path + summary fields (or "NO SUMMARY" if absent).
On read errors: file path + "ERROR: <type>: <message>".
Batch/stdin mode outputs one block per file, separated by ---
Exit code 2 if any file had errors (per tool contract: fail-closed).
"""
import re
import sys


def extract_summary(filepath: str) -> tuple[str, dict[str, str] | None, str | None]:
    """Return (filepath, {summary, keywords}, error).

    On success: error is None, fields may be None (true absence).
    On failure: error is a diagnostic string, fields is None.
    """
    try:
        with open(filepath, "r", encoding="utf-8", errors="replace") as f:
            content = f.read()

        # Match YAML frontmatter at start of file
        match = re.match(r"^---\n(.*?)\n---", content, re.DOTALL)
        if not match:
            return filepath, None, None

        block = match.group(1)
        fields = {}
        for line in block.strip().split("\n"):
            if ":" in line:
                key, _, value = line.partition(":")
                fields[key.strip()] = value.strip()

        if "summary" not in fields:
            return filepath, None, None

        return filepath, fields, None
    except (OSError, ValueError) as exc:
        return filepath, None, f"{type(exc).__name__}: {exc}"


def print_result(filepath: str, fields: dict[str, str] | None, error: str | None) -> None:
    print(filepath)
    if error:
        print(f"ERROR: {error}")
    elif fields:
        for key, value in fields.items():
            print(f"{key}: {value}")
    else:
        print("NO SUMMARY")


def main() -> None:
    args = sys.argv[1:]
    if not args:
        print(__doc__, file=sys.stderr)
        sys.exit(1)

    error_count = 0

    if args[0] == "--stdin":
        files = [line.strip() for line in sys.stdin if line.strip()]
        for i, f in enumerate(files):
            if i > 0:
                print("---")
            filepath, fields, err = extract_summary(f)
            if err:
                error_count += 1
            print_result(filepath, fields, err)
    elif args[0] == "--batch":
        files = args[1:]
        for i, f in enumerate(files):
            if i > 0:
                print("---")
            filepath, fields, err = extract_summary(f)
            if err:
                error_count += 1
            print_result(filepath, fields, err)
    else:
        filepath, fields, err = extract_summary(args[0])
        if err:
            error_count += 1
        print_result(filepath, fields, err)

    if error_count > 0:
        sys.exit(2)


if __name__ == "__main__":
    main()
